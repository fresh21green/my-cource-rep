import os
import requests
import httpx
from fastapi import FastAPI, Request
from telegram import  Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes


#–ü–æ–¥–∫–ª—é—á–∞–µ–º Amvera –∞–¥–∞–ø—Ç–µ—Ä
from langchain_amvera import AmveraLLM
from dotenv import load_dotenv

load_dotenv()

# LAOZHANG_API_KEY = os.getenv("LAOZHANG_API_KEY")
# LAOZHANG_MODEL = "gpt-4o"
# LAOZHANG_API_URL = "https://api.laozhang.ai/v1/chat/completions"

AMVERA_API_KEY = os.getenv("AMVERA_API_KEY")
AMVERA_MODEL = "gpt-4.1"
# AMVERA_API_URL = "https://models/gpt"

TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_API_URL = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}"

RENDER_API_KEY = os.getenv("RENDER_API_KEY")
RENDER_API_URL = "https://api.render.com/v1/services"

# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏: llama8b, llama70b, gpt-4.1, gpt-5
llm = AmveraLLM(model="gpt-4.1", api_token=AMVERA_API_KEY)

app = FastAPI()

def send_message(chat_id: int, text: str):
    requests.post(f"{TELEGRAM_API_URL}/sendMessage", json={
        "chat_id": chat_id,
        "text": text
    })

# —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –Ω–∞ Render
async def create_new_instance():
    headers = {
        "Authorization": f"Bearer {RENDER_API_KEY}",
        "Accept": "application/json",
        "Content-Type": "application/json"
    }

    payload = {
        "type": "web_service",
        "name": "bot-copy",  # Render —Å–∞–º –¥–æ–±–∞–≤–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—É—Ñ—Ñ–∏–∫—Å
        "env": "python",
        "repo": "https://github.com/fresh21green/my-cource-rep",
        "branch": "main",
        "buildCommand": "pip install -r requirements.txt",
        "startCommand": "python bot.py",
        "region": "oregon"
    }

    async with httpx.AsyncClient() as client:
        resp = await client.post(RENDER_API_URL, headers=headers, json=payload)
        if resp.status_code != 201:
            return {"error": resp.text}
        return resp.json()

# –∫–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE): 
    keyboard = [
        [InlineKeyboardButton("üöÄ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", callback_data="clone")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞:", reply_markup=reply_markup)

@app.post("/webhook")
async def webhook(request: Request):
    data = await request.json()
    update = Update.de_json(data, None)

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ /start
    if update.message.text == "/start":
        chat_id = update.message.chat.id
        keyboard = [[InlineKeyboardButton("üöÄ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", callback_data="clone")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        send_message(chat_id, "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞:")
        return {"ok": True}

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ clone
    if update.callback_query:
        if update.callback_query.data == "clone":
            result = await create_new_instance()
            chat_id = update.callback_query.message.chat.id
            send_message(chat_id, f"‚úÖ –ù–æ–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å —Å–æ–∑–¥–∞–Ω!\n\n{result}")
        return {"ok": True}

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ clone
    if update.message and update.message.text:
        if update.message.text == "/clone":
            result = await create_new_instance()
            send_message(update.message.chat.id, f"‚úÖ –ù–æ–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å —Å–æ–∑–¥–∞–Ω!\n\n{result}")
            return {"ok": True}

        user_text = update.message.text
        chat_id = update.message.chat.id 

        resp = llm.invoke(user_text)
        reply_text = str(resp)  # –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

        send_message(chat_id, reply_text)
        # –ó–∞–ø—Ä–æ—Å –≤ laozhang.ai
        # headers = {
        #     "Authorization": f"Bearer {LAOZHANG_API_KEY}",#LAOZHANG_API_KEY
        #     "Content-Type": "application/json"
        # }
        # payload = {
        #     "model": LAOZHANG_MODEL,#LAOZHANG_MODEL
        #     "messages": [
        #         {"role": "system", "content": "You are a helpful assistant."},
        #         {"role": "user", "content": user_text}
        #     ]
        # }

        # try:
        #     resp = requests.post(LAOZHANG_API_URL, headers=headers, json=payload),#LAOZHANG_API_URL
        #     if resp.status_code == 200:
        #         data = resp.json()
        #         reply_text = data["choices"][0]["message"]["content"]
        #     else:
        #         reply_text = f"–û—à–∏–±–∫–∞ API: {resp.text}"
        # except Exception as e:
        #     reply_text = f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}"

        # –ó–∞–ø—Ä–æ—Å –≤ amvera

    return {"ok": True}
